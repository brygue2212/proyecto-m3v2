require("./util/database")()
const conn = connection()

const express = require("express")
const bcrypt  = require("bcrypt")
const jwt     = require("jsonwebtoken")
const path    = require("path")
const parser  = require("body-parser")
const app     = express()
const port    = 3001
let nivel_acceso = ""

//motor de renderizado
app.set("views",path.join(__dirname,"/views"))  //establecer motor de vistas
app.engine("ejs", require("ejs").__express)  //establecer motor de renderizado
app.set("view engine", "ejs")  //establecer condiciones de los archivos
app.use(express.static(__dirname+"/views"))  //para usar css o bootstrap, static= carpeta publica
app.use(parser.urlencoded({extended:true}))

app.get("/", function(req,res){
  res.render("principal")
})

app.get("/iniciar", function(req,res){
  res.render("inicio de seccion")
})

app.get("/registro", function(req,res){
  res.render("Registro")
})

app.get("/meta", function(req,res){
  res.render("metaverse")
})

app.get("/admin", function(req,res){
  res.render("admin")
})

app.get("/RProductos", function(req,res){
  res.render("Registro_Productos")
})


app.listen(port, () => {
  conn.connect(function(err){
    if(err)throw err 
    console.log("servidor corriendo en http://localhost:"+port)
  })
})

app.post("/bd_registro_login", function(req,res){
  const nombre_completo=req.body.nombre_completo
  const correo=req.body.correo
  const usuario=req.body.usuario
  const clave=req.body.clave

  bcrypt.hash(clave, 10, function(err,hash){
      if(err){
          throw err
      }else{
        var sql=`INSERT INTO registro(nombre_completo, correo, usuario, clave) VALUES ("${nombre_completo}", "${correo}" ,"${usuario}",  "${hash}");`
  conn.query(sql,function(err,data,fields){
      if(err) throw err
      res.redirect("/iniciar")
              })
          }
  })
})

app.post("/bd_registro_login", function(req,res){
  const codigo_producto=req.body.codigo_producto
  const nombre_producto=req.body.nombre_producto
  const tipo_produto=req.body.tipo_produto
  const cantidad_produto=req.body.cantidad_produto
  const Tiempo=req.body.Tiempo
  const mone_pro=req.body.mone_pro
  

  var sql=`INSERT INTO productos(codigo_producto, nombre_producto, tipo_produto, cantidad_produto, mone_pro, Tiempo) VALUES ("${codigo_producto}","${nombre_producto}","${tipo_produto}","${cantidad_produto}","${mone_pro}","${Tiempo}");`
  conn.query(sql,function(err,data,fields){
      if(err) throw err
      res.redirect("/admin")
  })
})


//ruta raiz del servidor y parametros
app.get("/agregarUser/:usuario/:psw",function(req,res){
  let {usuario,psw}=req.params
  res.send({usuario,psw})
})

app.get("/views", function(req,res){
  if (nivel_acceso=="admin") {
    res.render("admin")
  } else if (nivel_acceso=="usuario") {
    res.render("index1")
  } else {
    res.send("primero inicia sesion")
  }
})

app.get("/views", function(req,res){
  res.render("admin")
})

app.post("/validar", async function(req, res){
  const { correo_usu,psw } = req.body
  const sql = `SELECT * FROM usuarios WHERE correo_usu = "${correo_usu}";`
  
  let isAuth = false

  await conn.query(sql, function(err, data){
    if(err) throw err
    console.log(data)
    new Promise(function(resolve, reject){
      bcrypt.compare(psw, data[0].psw, function(err, res){
        if(err) throw err
        if(res){
          isAuth = true
          resolve(isAuth)
        }
        reject(isAuth)
      })
    })
    .then(function(result){
      nivel_acceso = data[0].niv_acc
      isAuth == result ? res.redirect("/views") : console.log("contraseña es incorrecta")
    })
    .catch(function(err){
      res.send("Contraseña incorrecta")
    })
  })
})